<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Sensores Agrícolas</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
.sensor-card:hover{transform:translateY(-2px);transition:0.3s;box-shadow:0 4px 12px rgba(0,0,0,0.15);}
.badge-custom{padding:0.5em 1em;}
</style>
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-dark bg-primary">
<div class="container-fluid">
<span class="navbar-brand"><i class="fas fa-tint"></i> Dashboard Sensores Agrícolas</span>
<span class="text-white"><i class="fas fa-link"></i> Cardano Preview</span>
</div>
</nav>

<!-- Container Principal -->
<div class="container-fluid mt-4">

<!-- Estadísticas -->
<div class="row mb-4">
<div class="col-md-3">
<div class="card sensor-card">
<div class="card-body text-center">
<i class="fas fa-microchip fa-2x text-primary mb-2"></i>
<h3 id="totalSensors">0</h3>
<p class="text-muted mb-0">Sensores Activos</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card sensor-card">
<div class="card-body text-center">
<i class="fas fa-chart-line fa-2x text-success mb-2"></i>
<h3 id="totalReadings">0</h3>
<p class="text-muted mb-0">Lecturas Totales</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card sensor-card">
<div class="card-body text-center">
<i class="fas fa-clock fa-2x text-info mb-2"></i>
<h3 id="lastUpdate">--:--</h3>
<p class="text-muted mb-0">Última Actualización</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card sensor-card">
<div class="card-body text-center">
<button class="btn btn-primary w-100" onclick="loadAllData()">
<i class="fas fa-sync-alt"></i> Actualizar
</button>
</div>
</div>
</div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
<li class="nav-item">
<button class="nav-link active" id="sensors-tab" data-bs-toggle="tab" data-bs-target="#sensors" type="button">
<i class="fas fa-microchip"></i> Sensores
</button>
</li>
<li class="nav-item">
<button class="nav-link" id="readings-tab" data-bs-toggle="tab" data-bs-target="#readings" type="button">
<i class="fas fa-chart-bar"></i> Lecturas por Sensor
</button>
</li>
<li class="nav-item">
<button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button">
<i class="fas fa-plus-circle"></i> Registrar Sensor
</button>
</li>
</ul>

<!-- Tab Content -->
<div class="tab-content">

<!-- TAB: Sensores -->
<div class="tab-pane fade show active" id="sensors">
<div class="card">
<div class="card-header bg-white">
<h5 class="mb-0"><i class="fas fa-list"></i> Información Detallada de Sensores</h5>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-hover" id="sensorsTable">
<thead class="table-light">
<tr>
<th>ID</th>
<th>Zona / Ubicación</th>
<th>Coordenadas</th>
<th>Umbrales (%)</th>
<th>Intervalo</th>
<th>Estado</th>
<th>Fecha Instalación</th>
<th>Owner</th>
</tr>
</thead>
<tbody id="sensorsTableBody">
<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- TAB: Lecturas por Sensor -->
<div class="tab-pane fade" id="readings">
<div class="card mb-3">
<div class="card-header bg-white">
<div class="row align-items-center">
<div class="col-md-6">
<h5 class="mb-0"><i class="fas fa-filter"></i> Filtrar Lecturas</h5>
</div>
<div class="col-md-6">
<select class="form-select" id="sensorFilter" onchange="loadReadingsBySensor()">
<option value="">Todos los sensores</option>
</select>
</div>
</div>
</div>
<div class="card-body">
<canvas id="readingsChart" height="80"></canvas>
</div>
</div>

<div class="card">
<div class="card-header bg-white">
<h5 class="mb-0"><i class="fas fa-table"></i> Historial de Lecturas</h5>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-sm table-striped">
<thead>
<tr>
<th>Sensor ID</th>
<th>Humedad (%)</th>
<th>Temperatura (°C)</th>
<th>Nivel de Alerta</th>
<th>Fecha/Hora</th>
</tr>
</thead>
<tbody id="readingsTableBody">
<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- TAB: Registrar Sensor -->
<div class="tab-pane fade" id="register">
<div class="card" style="max-width:800px;margin:0 auto;">
<div class="card-header bg-white">
<h5 class="mb-0"><i class="fas fa-plus-circle"></i> Registrar Nuevo Sensor en Blockchain</h5>
</div>
<div class="card-body">
<form id="registerForm" class="row g-3">
<div class="col-md-12">
<label class="form-label"><i class="fas fa-map-marker-alt"></i> Nombre de la Zona</label>
<input type="text" class="form-control" id="zone" placeholder="Ej: Campo Norte - Parcela A" required>
</div>
<div class="col-md-6">
<label class="form-label"><i class="fas fa-globe"></i> Latitud</label>
<input type="number" class="form-control" id="lat" step="0.000001" placeholder="-34.603722" required>
</div>
<div class="col-md-6">
<label class="form-label"><i class="fas fa-globe"></i> Longitud</label>
<input type="number" class="form-control" id="lon" step="0.000001" placeholder="-58.381592" required>
</div>
<div class="col-md-4">
<label class="form-label"><i class="fas fa-arrow-down"></i> Humedad Mínima (%)</label>
<input type="number" class="form-control" id="minH" min="0" max="100" placeholder="30" required>
</div>
<div class="col-md-4">
<label class="form-label"><i class="fas fa-arrow-up"></i> Humedad Máxima (%)</label>
<input type="number" class="form-control" id="maxH" min="0" max="100" placeholder="70" required>
</div>
<div class="col-md-4">
<label class="form-label"><i class="fas fa-clock"></i> Intervalo (min)</label>
<input type="number" class="form-control" id="interval" min="1" placeholder="60" required>
</div>
<div class="col-12">
<button type="submit" class="btn btn-success btn-lg w-100">
<i class="fas fa-save"></i> Registrar en Blockchain
</button>
</div>
</form>
<div id="result" class="mt-3"></div>
</div>
</div>
</div>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = 'http://localhost:8000/api';
let chart;
let allSensors = [];
let allReadings = [];

// Función para formatear fecha
function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleString('es-AR', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
    });
}

// Función para obtener color según alerta
function getAlertBadge(level) {
    const colors = {
        Normal: 'success',
        Low: 'warning',
        High: 'warning',
        Critical: 'danger'
    };
    return `<span class="badge bg-${colors[level] || 'secondary'}">${level}</span>`;
}

// Cargar sensores con información detallada
async function loadSensors() {
    try {
        allSensors = await fetch(API + '/sensors').then(r => r.json());
        document.getElementById('totalSensors').textContent = allSensors.length;

        // Poblar filtro de sensores
        const filter = document.getElementById('sensorFilter');
        filter.innerHTML = '<option value="">Todos los sensores</option>' +
            allSensors.map(s => `<option value="${s.sensor_id}">${s.sensor_id} - ${s.location.zone_name}</option>`).join('');

        // Tabla detallada
        const tbody = document.getElementById('sensorsTableBody');
        tbody.innerHTML = allSensors.map(s => `
            <tr>
                <td><strong>${s.sensor_id}</strong></td>
                <td>${s.location.zone_name}</td>
                <td><small>${s.location.latitude.toFixed(4)}, ${s.location.longitude.toFixed(4)}</small></td>
                <td><span class="badge bg-info">${s.min_humidity_threshold}% - ${s.max_humidity_threshold}%</span></td>
                <td>${s.reading_interval_minutes} min</td>
                <td><span class="badge bg-${s.status === 'Active' ? 'success' : 'secondary'}">${s.status}</span></td>
                <td><small>${formatDate(s.installed_date)}</small></td>
                <td><small class="text-muted">${s.owner.substring(0, 8)}...</small></td>
            </tr>
        `).join('');
    } catch(e) {
        console.error('Error cargando sensores:', e);
    }
}

// Cargar lecturas filtradas por sensor
async function loadReadingsBySensor() {
    const sensorId = document.getElementById('sensorFilter').value;
    const url = sensorId ? `${API}/readings?sensor_id=${sensorId}&limit=20` : `${API}/readings?limit=20`;

    try {
        allReadings = await fetch(url).then(r => r.json());
        document.getElementById('totalReadings').textContent = allReadings.length;

        // Tabla de lecturas
        const tbody = document.getElementById('readingsTableBody');
        tbody.innerHTML = allReadings.map(r => `
            <tr>
                <td><strong>${r.sensor_id}</strong></td>
                <td><span class="badge badge-custom bg-primary">${r.humidity_percentage}%</span></td>
                <td>${r.temperature_celsius}°C</td>
                <td>${getAlertBadge(r.alert_level)}</td>
                <td><small>${formatDate(r.timestamp)}</small></td>
            </tr>
        `).join('');

        // Gráfica
        updateChart();
    } catch(e) {
        console.error('Error cargando lecturas:', e);
    }
}

// Actualizar gráfica
function updateChart() {
    if (chart) chart.destroy();

    const ctx = document.getElementById('readingsChart');
    const labels = allReadings.map(r => `${r.sensor_id}\n${formatDate(r.timestamp).split(' ')[1]}`);

    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.reverse(),
            datasets: [{
                label: 'Humedad (%)',
                data: allReadings.map(r => r.humidity_percentage).reverse(),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4
            }, {
                label: 'Temperatura (°C)',
                data: allReadings.map(r => r.temperature_celsius).reverse(),
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true },
                title: { display: true, text: 'Historial de Lecturas' }
            }
        }
    });
}

// Cargar todos los datos
async function loadAllData() {
    await loadSensors();
    await loadReadingsBySensor();
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('es-AR');
}

// Formulario de registro
document.getElementById('registerForm').onsubmit = async (e) => {
    e.preventDefault();
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Enviando transacción a blockchain...</div>';

    try {
        const data = {
            location: {
                zone_name: zone.value,
                latitude: parseFloat(lat.value),
                longitude: parseFloat(lon.value)
            },
            min_humidity_threshold: parseInt(minH.value),
            max_humidity_threshold: parseInt(maxH.value),
            reading_interval_minutes: parseInt(interval.value)
        };

        const res = await fetch(API + '/sensors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const json = await res.json();

        if (res.ok) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle"></i> ${json.message}</h6>
                    <p class="mb-2">TxHash: <code>${json.tx_hash}</code></p>
                    <a href="${json.explorer_url}" target="_blank" class="btn btn-sm btn-primary">
                        <i class="fas fa-external-link-alt"></i> Ver en Cardano Explorer
                    </a>
                </div>
            `;
            e.target.reset();
            setTimeout(loadAllData, 3000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${json.detail || 'Error al registrar'}</div>`;
        }
    } catch(error) {
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Error: ${error.message}</div>`;
    }
};

// Cargar datos al inicio
loadAllData();
</script>
</body>
</html>
