<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Cache busting: v2.0 -->
<title>Dashboard Sensores Agrícolas</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
.sensor-card:hover{transform:translateY(-2px);transition:0.3s;box-shadow:0 4px 12px rgba(0,0,0,0.15);}
.badge-custom{padding:0.5em 1em;}
.btn-verification{
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  color: white;
  font-weight: 600;
  padding: 8px 20px;
  border-radius: 6px;
  transition: all 0.3s;
}
.btn-verification:hover{
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  color: white;
}
</style>
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-dark bg-primary">
<div class="container-fluid">
<span class="navbar-brand"><i class="fas fa-tint"></i> Dashboard Sensores Agrícolas</span>
<div class="d-flex align-items-center gap-3">
<a href="/static/verificacion.html" class="btn btn-verification btn-sm">
<i class="fas fa-check-circle"></i> Verificación Blockchain
</a>
<span class="text-white"><i class="fas fa-link"></i> Cardano Preview</span>
</div>
</div>
</nav>

<!-- Container Principal -->
<div class="container-fluid mt-4">

<!-- Estadísticas -->
<div class="row mb-4">
<div class="col-md-3">
<div class="card sensor-card">
<div class="card-body text-center">
<i class="fas fa-microchip fa-2x text-primary mb-2"></i>
<h3 id="totalSensors">0</h3>
<p class="text-muted mb-0">Sensores Activos</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card sensor-card">
<div class="card-body text-center">
<i class="fas fa-chart-line fa-2x text-success mb-2"></i>
<h3 id="totalReadings">0</h3>
<p class="text-muted mb-0">Lecturas Totales</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card sensor-card">
<div class="card-body text-center">
<i class="fas fa-clock fa-2x text-info mb-2"></i>
<h3 id="lastUpdate">--:--</h3>
<p class="text-muted mb-0">Última Actualización</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card sensor-card">
<div class="card-body text-center">
<button class="btn btn-primary w-100" onclick="loadAllData()">
<i class="fas fa-sync-alt"></i> Actualizar
</button>
</div>
</div>
</div>
</div>

<!-- Alertas Activas -->
<div class="row mb-4" id="alertsPanel" style="display:none;">
<div class="col-12">
<div class="alert alert-warning mb-3" role="alert">
<div class="row align-items-center">
<div class="col-md-2 text-center">
<i class="fas fa-exclamation-triangle fa-3x"></i>
</div>
<div class="col-md-10">
<h5 class="alert-heading mb-2"><i class="fas fa-bell"></i> Alertas Activas</h5>
<div class="row">
<div class="col-md-3">
<strong id="alertCriticalCount">0</strong> Críticas
</div>
<div class="col-md-3">
<strong id="alertHighCount">0</strong> Altas
</div>
<div class="col-md-3">
<strong id="alertLowCount">0</strong> Bajas
</div>
<div class="col-md-3">
<strong id="alertTotalCount">0</strong> Total
</div>
</div>
<button class="btn btn-sm btn-warning mt-2" onclick="document.getElementById('alerts-tab').click()">
<i class="fas fa-eye"></i> Ver Alertas
</button>
</div>
</div>
</div>
</div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
<li class="nav-item">
<button class="nav-link active" id="sensors-tab" data-bs-toggle="tab" data-bs-target="#sensors" type="button">
<i class="fas fa-microchip"></i> Sensores
</button>
</li>
<li class="nav-item">
<button class="nav-link" id="readings-tab" data-bs-toggle="tab" data-bs-target="#readings" type="button">
<i class="fas fa-chart-bar"></i> Lecturas por Sensor
</button>
</li>
<li class="nav-item">
<button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button">
<i class="fas fa-plus-circle"></i> Registrar Sensor
</button>
</li>
<li class="nav-item">
<button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button">
<i class="fas fa-bell"></i> Alertas <span class="badge bg-danger" id="alertsBadge" style="display:none;">0</span>
</button>
</li>
<li class="nav-item">
<button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button">
<i class="fas fa-check-double"></i> Auditoría Blockchain
</button>
</li>
</ul>

<!-- Tab Content -->
<div class="tab-content">

<!-- TAB: Sensores -->
<div class="tab-pane fade show active" id="sensors">
<div class="card">
<div class="card-header bg-white">
<h5 class="mb-0"><i class="fas fa-list"></i> Información Detallada de Sensores</h5>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-hover" id="sensorsTable">
<thead class="table-light">
<tr>
<th>ID</th>
<th>Zona / Ubicación</th>
<th>Coordenadas</th>
<th>Umbrales (%)</th>
<th>Intervalo</th>
<th>Estado</th>
<th>Fecha Instalación</th>
<th>Owner</th>
</tr>
</thead>
<tbody id="sensorsTableBody">
<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- TAB: Lecturas por Sensor -->
<div class="tab-pane fade" id="readings">
<div class="card mb-3">
<div class="card-header bg-white">
<div class="row align-items-center">
<div class="col-md-6">
<h5 class="mb-0"><i class="fas fa-filter"></i> Filtrar Lecturas</h5>
</div>
<div class="col-md-6">
<select class="form-select" id="sensorFilter" onchange="loadReadingsBySensor()">
<option value="">Todos los sensores</option>
</select>
</div>
</div>
</div>
<div class="card-body">
<canvas id="readingsChart" height="80"></canvas>
</div>
</div>

<!-- Sección de Alertas de Errores de Rollup -->
<div class="card mb-3" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none;">
<div class="card-body">
<h5 class="text-white mb-3"><i class="fas fa-exclamation-triangle"></i> Alertas de Errores en Rollups</h5>
<p class="text-white mb-3" style="opacity: 0.9;">
Monitorea errores en el procesamiento de rollups diarios. Los errores se registran automáticamente.
</p>
<div class="row g-3 mb-3">
<div class="col-md-4">
<div class="card" style="background: rgba(255,255,255,0.95); border: none;">
<div class="card-body text-center">
<h3 class="mb-0" id="totalErrors" style="color: #f5576c; font-weight: 700;">-</h3>
<small class="text-muted">Total Errores</small>
</div>
</div>
</div>
<div class="col-md-4">
<div class="card" style="background: rgba(255,255,255,0.95); border: none;">
<div class="card-body text-center">
<h3 class="mb-0" id="unresolvedErrors" style="color: #dc3545; font-weight: 700;">-</h3>
<small class="text-muted">No Resueltos</small>
</div>
</div>
</div>
<div class="col-md-4">
<div class="card" style="background: rgba(255,255,255,0.95); border: none;">
<div class="card-body text-center">
<button onclick="loadRollupErrors()" class="btn btn-light btn-sm w-100" style="font-weight: 600;">
<i class="fas fa-sync-alt"></i> Actualizar
</button>
</div>
</div>
</div>
</div>
<div id="rollupErrorsList" style="max-height: 300px; overflow-y: auto;">
<div class="text-white text-center">
<i class="fas fa-spinner fa-spin"></i> Cargando errores...
</div>
</div>
</div>
</div>

<!-- Sección de Verificación Merkle Proof -->
<div class="card mb-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
<div class="card-body">
<h5 class="text-white mb-3"><i class="fas fa-shield-alt"></i> Verificar Lectura con Merkle Proof</h5>
<p class="text-white mb-3" style="opacity: 0.9;">
Verifica la integridad criptográfica de cualquier lectura. Usa el ID de la tabla de abajo o haz clic en "Verificar".
</p>
<div class="row g-2">
<div class="col-md-9">
<input type="number" id="readingIdInput" class="form-control form-control-lg" placeholder="Ingresa el ID de la lectura (ej: 290, 291, 292...)" style="border: 2px solid white;">
</div>
<div class="col-md-3">
<button onclick="verifyReading()" class="btn btn-light btn-lg w-100" style="font-weight: 600;">
<i class="fas fa-search"></i> Verificar
</button>
</div>
</div>
<div id="merkleProofResult" class="mt-3" style="display: none;"></div>
</div>
</div>

<div class="card">
<div class="card-header bg-white d-flex justify-content-between align-items-center">
<h5 class="mb-0"><i class="fas fa-table"></i> Historial de Lecturas</h5>
<div>
<span class="badge bg-info me-2" id="readingsCount">0 lecturas</span>
<span class="badge bg-secondary" id="pageInfo">Página 1</span>
</div>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-sm table-striped">
<thead>
<tr>
<th>#</th>
<th style="color: #667eea; font-weight: 600;">ID</th>
<th>Sensor ID</th>
<th>Humedad (%)</th>
<th>Temperatura (°C)</th>
<th>Nivel de Alerta</th>
<th>Fecha/Hora</th>
<th>TX Hash</th>
<th style="text-align: center;">Acción</th>
</tr>
</thead>
<tbody id="readingsTableBody">
<tr><td colspan="9" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>
</tbody>
</table>
</div>

<!-- Paginación -->
<div class="d-flex justify-content-between align-items-center mt-3">
<div class="d-flex gap-2">
<button class="btn btn-outline-primary btn-sm" id="btnFirstPage" onclick="goToFirstPage()" disabled>
<i class="fas fa-angle-double-left"></i> Primera
</button>
<button class="btn btn-outline-primary btn-sm" id="btnPrevPage" onclick="prevPage()" disabled>
<i class="fas fa-chevron-left"></i> Anterior
</button>
</div>
<div class="text-center">
<div id="pageNumbers" class="btn-group mb-2" role="group"></div>
<div><small class="text-muted" id="paginationInfo">Mostrando 0 de 0 lecturas</small></div>
</div>
<div class="d-flex gap-2">
<button class="btn btn-outline-primary btn-sm" id="btnNextPage" onclick="nextPage()" disabled>
Siguiente <i class="fas fa-chevron-right"></i>
</button>
<button class="btn btn-outline-primary btn-sm" id="btnLastPage" onclick="goToLastPage()" disabled>
Última <i class="fas fa-angle-double-right"></i>
</button>
</div>
</div>
</div>
</div>
</div>

<!-- TAB: Registrar Sensor -->
<div class="tab-pane fade" id="register">
<div class="card" style="max-width:800px;margin:0 auto;">
<div class="card-header bg-white">
<h5 class="mb-0"><i class="fas fa-plus-circle"></i> Registrar Nuevo Sensor en Blockchain</h5>
</div>
<div class="card-body">
<form id="registerForm" class="row g-3">
<div class="col-md-12">
<label class="form-label"><i class="fas fa-map-marker-alt"></i> Nombre de la Zona</label>
<input type="text" class="form-control" id="zone" placeholder="Ej: Campo Norte - Parcela A" required>
</div>
<div class="col-md-6">
<label class="form-label"><i class="fas fa-globe"></i> Latitud</label>
<input type="number" class="form-control" id="lat" step="0.000001" placeholder="-34.603722" required>
</div>
<div class="col-md-6">
<label class="form-label"><i class="fas fa-globe"></i> Longitud</label>
<input type="number" class="form-control" id="lon" step="0.000001" placeholder="-58.381592" required>
</div>
<div class="col-md-4">
<label class="form-label"><i class="fas fa-arrow-down"></i> Humedad Mínima (%)</label>
<input type="number" class="form-control" id="minH" min="0" max="100" placeholder="30" required>
</div>
<div class="col-md-4">
<label class="form-label"><i class="fas fa-arrow-up"></i> Humedad Máxima (%)</label>
<input type="number" class="form-control" id="maxH" min="0" max="100" placeholder="70" required>
</div>
<div class="col-md-4">
<label class="form-label"><i class="fas fa-clock"></i> Intervalo (min)</label>
<input type="number" class="form-control" id="interval" min="1" placeholder="60" required>
</div>
<div class="col-12">
<button type="submit" class="btn btn-success btn-lg w-100">
<i class="fas fa-save"></i> Registrar en Blockchain
</button>
</div>
</form>
<div id="result" class="mt-3"></div>
</div>
</div>
</div>

<!-- TAB: Auditoría Blockchain -->
<div class="tab-pane fade" id="audit">
<div class="row mb-3">
<div class="col-md-12">
<div class="card">
<div class="card-header bg-white d-flex justify-content-between align-items-center">
<h5 class="mb-0"><i class="fas fa-check-double"></i> Auditoría de Integridad: Blockchain vs PostgreSQL</h5>
<button class="btn btn-primary btn-sm" onclick="loadAuditData()">
<i class="fas fa-sync-alt"></i> Actualizar
</button>
</div>
<div class="card-body">
<!-- Resumen -->
<div class="row mb-4">
<div class="col-md-3">
<div class="card bg-light">
<div class="card-body text-center">
<h4 id="auditIntegrity">--</h4>
<p class="mb-0 text-muted">Integridad</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-light">
<div class="card-body text-center">
<h4 id="auditMatches">--</h4>
<p class="mb-0 text-muted">Coincidencias</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-light">
<div class="card-body text-center">
<h4 id="auditDifferent">--</h4>
<p class="mb-0 text-muted">Valores Diferentes</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-light">
<div class="card-body text-center">
<h4 id="auditOnlyBC">--</h4>
<p class="mb-0 text-muted">Solo en Blockchain</p>
</div>
</div>
</div>
</div>

<!-- Tabla de comparación -->
<div class="table-responsive">
<table class="table table-sm table-hover">
<thead class="table-light">
<tr>
<th>#</th>
<th>Sensor</th>
<th>Timestamp Blockchain</th>
<th>Blockchain</th>
<th>PostgreSQL</th>
<th>Estado</th>
<th>TX Hash</th>
</tr>
</thead>
<tbody id="auditTableBody">
<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando auditoría...</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- TAB: Alertas -->
<div class="tab-pane fade" id="alerts">
<div class="card">
<div class="card-header bg-white d-flex justify-content-between align-items-center">
<h5 class="mb-0"><i class="fas fa-bell"></i> Sistema de Alertas en Tiempo Real</h5>
<button class="btn btn-primary btn-sm" onclick="loadAlertsData()">
<i class="fas fa-sync-alt"></i> Actualizar
</button>
</div>
<div class="card-body">
<!-- Resumen de Alertas -->
<div class="row mb-4">
<div class="col-md-3">
<div class="card bg-danger text-white">
<div class="card-body text-center">
<h3 id="alertCritical">0</h3>
<p class="mb-0">Críticas</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-warning">
<div class="card-body text-center">
<h3 id="alertHigh">0</h3>
<p class="mb-0">Altas</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-info text-white">
<div class="card-body text-center">
<h3 id="alertLow">0</h3>
<p class="mb-0">Bajas</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-light">
<div class="card-body text-center">
<h3 id="alertTotal">0</h3>
<p class="mb-0">Total (24h)</p>
</div>
</div>
</div>
</div>

<!-- Filtros -->
<div class="row mb-3">
<div class="col-md-4">
<select class="form-select" id="alertLevelFilter" onchange="loadAlertsData()">
<option value="">Todos los niveles</option>
<option value="Critical">Críticas</option>
<option value="High">Altas</option>
<option value="Low">Bajas</option>
</select>
</div>
<div class="col-md-4">
<select class="form-select" id="alertSensorFilter" onchange="loadAlertsData()">
<option value="">Todos los sensores</option>
</select>
</div>
</div>

<!-- Tabla de Alertas Activas -->
<div class="table-responsive">
<table class="table table-hover">
<thead class="table-light">
<tr>
<th>Nivel</th>
<th>Sensor</th>
<th>Zona</th>
<th>Humedad</th>
<th>Temperatura</th>
<th>Rango</th>
<th>Mensaje</th>
<th>Duración</th>
<th>Timestamp</th>
</tr>
</thead>
<tbody id="alertsTableBody">
<tr><td colspan="9" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando alertas...</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = 'http://localhost:8000/api';
let chart;
let allSensors = [];
let allReadings = [];

// Función para formatear fecha
function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleString('es-AR', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
    });
}

// Función para obtener color según alerta
function getAlertBadge(level) {
    const colors = {
        Normal: 'success',
        Low: 'warning',
        High: 'warning',
        Critical: 'danger'
    };
    return `<span class="badge bg-${colors[level] || 'secondary'}">${level}</span>`;
}

// Cargar sensores con información detallada
async function loadSensors() {
    try {
        allSensors = await fetch(API + '/sensors').then(r => r.json());
        document.getElementById('totalSensors').textContent = allSensors.length;

        // Poblar filtro de sensores
        const filter = document.getElementById('sensorFilter');
        filter.innerHTML = '<option value="">Todos los sensores</option>' +
            allSensors.map(s => `<option value="${s.sensor_id}">${s.sensor_id} - ${s.location.zone_name}</option>`).join('');

        // Tabla detallada
        const tbody = document.getElementById('sensorsTableBody');
        tbody.innerHTML = allSensors.map(s => `
            <tr>
                <td><strong>${s.sensor_id}</strong></td>
                <td>${s.location.zone_name}</td>
                <td><small>${s.location.latitude.toFixed(4)}, ${s.location.longitude.toFixed(4)}</small></td>
                <td><span class="badge bg-info">${s.min_humidity_threshold}% - ${s.max_humidity_threshold}%</span></td>
                <td>${s.reading_interval_minutes} min</td>
                <td><span class="badge bg-${s.status === 'Active' ? 'success' : 'secondary'}">${s.status}</span></td>
                <td><small>${formatDate(s.installed_date)}</small></td>
                <td><small class="text-muted">${s.owner.substring(0, 8)}...</small></td>
            </tr>
        `).join('');
    } catch(e) {
        console.error('Error cargando sensores:', e);
    }
}

// Variables de paginación
let currentPage = 1;
const itemsPerPage = 20;
let totalReadings = [];

// Cargar lecturas filtradas por sensor
async function loadReadingsBySensor() {
    const sensorId = document.getElementById('sensorFilter').value;
    const url = sensorId ? `${API}/readings?sensor_id=${sensorId}&limit=10000` : `${API}/readings?limit=10000`;

    try {
        const response = await fetch(url).then(r => r.json());

        // Asegurar que siempre sea un array
        totalReadings = Array.isArray(response) ? response : [];
        allReadings = totalReadings; // Para el gráfico

        document.getElementById('totalReadings').textContent = totalReadings.length;
        document.getElementById('readingsCount').textContent = `${totalReadings.length} lecturas`;

        // Resetear a página 1
        currentPage = 1;

        // Mostrar página actual
        displayCurrentPage();

        // Gráfica
        updateChart();
    } catch(e) {
        console.error('Error cargando lecturas:', e);
        // En caso de error, asegurar que totalReadings sea un array vacío
        totalReadings = [];
        displayCurrentPage();
    }
}

// Mostrar página actual
function displayCurrentPage() {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageReadings = totalReadings.slice(startIndex, endIndex);

    // Tabla de lecturas con numeración
    const tbody = document.getElementById('readingsTableBody');

    if (pageReadings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No hay lecturas para mostrar</td></tr>';
    } else {
        tbody.innerHTML = pageReadings.map((r, idx) => `
            <tr>
                <td><strong>${startIndex + idx + 1}</strong></td>
                <td><strong style="color: #667eea;">${r.id || 'N/A'}</strong></td>
                <td><strong>${r.sensor_id}</strong></td>
                <td><span class="badge badge-custom bg-primary">${r.humidity_percentage}%</span></td>
                <td>${r.temperature_celsius}°C</td>
                <td>${getAlertBadge(r.alert_level)}</td>
                <td><small>${formatDate(r.timestamp)}</small></td>
                <td>${r.tx_hash === 'PENDIENTE' ? '<span class="badge bg-warning">PENDIENTE</span>' : r.tx_hash && r.tx_hash.startsWith('simulated_tx_') ? `<span class="badge bg-secondary" title="${r.tx_hash}">SIMULADO</span>` : r.tx_hash ? `<a href="https://preview.cardanoscan.io/transaction/${r.tx_hash}" target="_blank" rel="noopener noreferrer" style="font-family:monospace;font-size:0.85em;" title="${r.tx_hash}">${r.tx_hash.substring(0, 8)}...${r.tx_hash.substring(r.tx_hash.length - 8)}</a>` : '<span style="color:#999;">-</span>'}</td>
                <td style="text-align: center;">
                    ${r.id ? `<button onclick="verifyReadingById(${r.id})" class="btn btn-sm" style="background:#667eea;color:white;font-weight:600;border:none;padding:4px 12px;">
                        <i class="fas fa-check-circle"></i> Verificar
                    </button>` : '<span class="badge bg-secondary">N/A</span>'}
                </td>
            </tr>
        `).join('');
    }

    // Actualizar info de paginación
    const totalPages = Math.ceil(totalReadings.length / itemsPerPage);
    document.getElementById('pageInfo').textContent = `Página ${currentPage} de ${totalPages}`;
    document.getElementById('paginationInfo').textContent = `Mostrando ${startIndex + 1}-${Math.min(endIndex, totalReadings.length)} de ${totalReadings.length} lecturas`;

    // Generar números de página (máximo 7 botones visibles)
    const pageNumbersDiv = document.getElementById('pageNumbers');
    let pageButtons = '';

    let startPage = Math.max(1, currentPage - 3);
    let endPage = Math.min(totalPages, currentPage + 3);

    // Ajustar si estamos cerca del inicio o final
    if (currentPage <= 4) {
        endPage = Math.min(7, totalPages);
    } else if (currentPage >= totalPages - 3) {
        startPage = Math.max(1, totalPages - 6);
    }

    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage ? 'btn-primary' : 'btn-outline-primary';
        pageButtons += `<button class="btn ${activeClass} btn-sm" onclick="goToPage(${i})">${i}</button>`;
    }

    pageNumbersDiv.innerHTML = pageButtons;

    // Habilitar/deshabilitar botones
    document.getElementById('btnFirstPage').disabled = currentPage === 1;
    document.getElementById('btnPrevPage').disabled = currentPage === 1;
    document.getElementById('btnNextPage').disabled = endIndex >= totalReadings.length;
    document.getElementById('btnLastPage').disabled = currentPage === totalPages || totalPages === 0;
}

// Ir a página específica
function goToPage(pageNumber) {
    const totalPages = Math.ceil(totalReadings.length / itemsPerPage);
    if (pageNumber >= 1 && pageNumber <= totalPages) {
        currentPage = pageNumber;
        displayCurrentPage();
    }
}

// Primera página
function goToFirstPage() {
    currentPage = 1;
    displayCurrentPage();
}

// Última página
function goToLastPage() {
    const totalPages = Math.ceil(totalReadings.length / itemsPerPage);
    if (totalPages > 0) {
        currentPage = totalPages;
        displayCurrentPage();
    }
}

// Página anterior
function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        displayCurrentPage();
    }
}

// Página siguiente
function nextPage() {
    const totalPages = Math.ceil(totalReadings.length / itemsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        displayCurrentPage();
    }
}

// Actualizar gráfica
function updateChart() {
    if (chart) chart.destroy();

    const ctx = document.getElementById('readingsChart');
    const labels = allReadings.map(r => `${r.sensor_id}\n${formatDate(r.timestamp).split(' ')[1]}`);

    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.reverse(),
            datasets: [{
                label: 'Humedad (%)',
                data: allReadings.map(r => r.humidity_percentage).reverse(),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4
            }, {
                label: 'Temperatura (°C)',
                data: allReadings.map(r => r.temperature_celsius).reverse(),
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true },
                title: { display: true, text: 'Historial de Lecturas' }
            }
        }
    });
}

// Cargar todos los datos
async function loadAllData() {
    await loadSensors();
    await loadReadingsBySensor();
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('es-AR');
}

// Formulario de registro
document.getElementById('registerForm').onsubmit = async (e) => {
    e.preventDefault();
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Enviando transacción a blockchain...</div>';

    try {
        const data = {
            location: {
                zone_name: zone.value,
                latitude: parseFloat(lat.value),
                longitude: parseFloat(lon.value)
            },
            min_humidity_threshold: parseInt(minH.value),
            max_humidity_threshold: parseInt(maxH.value),
            reading_interval_minutes: parseInt(interval.value)
        };

        const res = await fetch(API + '/sensors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const json = await res.json();

        if (res.ok) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle"></i> ${json.message}</h6>
                    <p class="mb-2">TxHash: <code>${json.tx_hash}</code></p>
                    <a href="${json.explorer_url}" target="_blank" class="btn btn-sm btn-primary">
                        <i class="fas fa-external-link-alt"></i> Ver en Cardano Explorer
                    </a>
                </div>
            `;
            e.target.reset();
            setTimeout(loadAllData, 3000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${json.detail || 'Error al registrar'}</div>`;
        }
    } catch(error) {
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Error: ${error.message}</div>`;
    }
};

// Cargar auditoría blockchain vs PostgreSQL
async function loadAuditData() {
    try {
        const response = await fetch(`${API}/audit/compare?limit=20`);
        const data = await response.json();

        if (!data.success) {
            console.error('Error en auditoría:', data);
            return;
        }

        // Actualizar tarjetas de resumen
        document.getElementById('auditIntegrity').textContent = data.resumen.integridad_porcentaje + '%';
        document.getElementById('auditMatches').textContent = data.resumen.matches;
        document.getElementById('auditDifferent').textContent = data.resumen.diferentes;
        document.getElementById('auditOnlyBC').textContent = data.resumen.solo_blockchain;

        // Poblar tabla de comparación
        const tbody = document.getElementById('auditTableBody');
        tbody.innerHTML = data.comparaciones.map((comp, idx) => {
            const bcData = `H:${comp.blockchain.humidity}% T:${comp.blockchain.temperature}°C`;
            const sqlData = comp.postgresql
                ? `H:${comp.postgresql.humidity}% T:${comp.postgresql.temperature}°C`
                : '<span style="color:#999;">[NO ENCONTRADO]</span>';

            // Badge de estado
            let statusBadge;
            if (comp.match_status === 'match') {
                statusBadge = '<span class="badge bg-success"><i class="fas fa-check"></i> MATCH</span>';
            } else if (comp.match_status === 'different_values') {
                statusBadge = '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle"></i> DIFERENTES</span>';
            } else {
                statusBadge = '<span class="badge bg-secondary"><i class="fas fa-times"></i> SOLO BC</span>';
            }

            // Link de TX Hash
            const txHashLink = comp.tx_hash
                ? `<a href="https://preview.cardanoscan.io/transaction/${comp.tx_hash}" target="_blank" rel="noopener noreferrer" style="font-family:monospace;font-size:0.85em;" title="${comp.tx_hash}">${comp.tx_hash.substring(0, 8)}...${comp.tx_hash.substring(comp.tx_hash.length - 8)}</a>`
                : '<span style="color:#999;">-</span>';

            // Formato de timestamp
            const timestampBC = formatDate(comp.timestamp_bc);

            return `
                <tr>
                    <td>${idx + 1}</td>
                    <td><strong>${comp.sensor_id}</strong></td>
                    <td><small>${timestampBC}</small></td>
                    <td><span class="badge badge-custom bg-info">${bcData}</span></td>
                    <td><span class="badge badge-custom bg-${comp.postgresql ? 'info' : 'secondary'}">${sqlData}</span></td>
                    <td>${statusBadge}</td>
                    <td>${txHashLink}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading audit data:', error);
        document.getElementById('auditTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger">
                    <i class="fas fa-exclamation-circle"></i> Error al cargar datos de auditoría: ${error.message}
                </td>
            </tr>
        `;
    }
}

// Cargar alertas activas
async function loadAlertsData() {
    try {
        // Obtener filtros
        const level = document.getElementById('alertLevelFilter')?.value || '';
        const sensorId = document.getElementById('alertSensorFilter')?.value || '';

        // Construir URL con filtros
        let url = `${API}/alerts/active`;
        const params = new URLSearchParams();
        if (level) params.append('level', level);
        if (sensorId) params.append('sensor_id', sensorId);
        if (params.toString()) url += '?' + params.toString();

        const response = await fetch(url);
        const alerts = await response.json();

        // Obtener resumen
        const summaryResponse = await fetch(`${API}/alerts/summary`);
        const summary = await summaryResponse.json();

        // Actualizar tarjetas de resumen
        document.getElementById('alertCritical').textContent = summary.critical_alerts || 0;
        document.getElementById('alertHigh').textContent = summary.high_alerts || 0;
        document.getElementById('alertLow').textContent = summary.low_alerts || 0;
        document.getElementById('alertTotal').textContent = summary.total_alerts || 0;

        // Actualizar panel superior de alertas
        const totalAlerts = summary.total_alerts || 0;
        if (totalAlerts > 0) {
            document.getElementById('alertsPanel').style.display = 'block';
            document.getElementById('alertCriticalCount').textContent = summary.critical_alerts || 0;
            document.getElementById('alertHighCount').textContent = summary.high_alerts || 0;
            document.getElementById('alertLowCount').textContent = summary.low_alerts || 0;
            document.getElementById('alertTotalCount').textContent = totalAlerts;

            // Actualizar badge en tab
            const badge = document.getElementById('alertsBadge');
            badge.textContent = totalAlerts;
            badge.style.display = 'inline';
        } else {
            document.getElementById('alertsPanel').style.display = 'none';
            document.getElementById('alertsBadge').style.display = 'none';
        }

        // Poblar tabla de alertas
        const tbody = document.getElementById('alertsTableBody');

        if (alerts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-success"><i class="fas fa-check-circle"></i> No hay alertas activas</td></tr>';
        } else {
            tbody.innerHTML = alerts.map(alert => {
                // Badge de nivel
                let levelBadge = '';
                if (alert.alert_level === 'Critical') {
                    levelBadge = '<span class="badge bg-danger"><i class="fas fa-exclamation-circle"></i> CRÍTICA</span>';
                } else if (alert.alert_level === 'High') {
                    levelBadge = '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle"></i> ALTA</span>';
                } else if (alert.alert_level === 'Low') {
                    levelBadge = '<span class="badge bg-info"><i class="fas fa-info-circle"></i> BAJA</span>';
                }

                // Formatear duración
                const duration = alert.duration_minutes;
                let durationText = '';
                if (duration < 60) {
                    durationText = `${duration} min`;
                } else if (duration < 1440) {
                    durationText = `${Math.floor(duration / 60)}h ${duration % 60}min`;
                } else {
                    durationText = `${Math.floor(duration / 1440)}d ${Math.floor((duration % 1440) / 60)}h`;
                }

                return `
                    <tr class="${alert.alert_level === 'Critical' ? 'table-danger' : ''}">
                        <td>${levelBadge}</td>
                        <td><strong>${alert.sensor_id}</strong></td>
                        <td>${alert.zone_name}</td>
                        <td><span class="badge badge-custom bg-primary">${alert.humidity_percentage}%</span></td>
                        <td>${alert.temperature_celsius}°C</td>
                        <td><small>${alert.threshold_min}% - ${alert.threshold_max}%</small></td>
                        <td><small>${alert.message}</small></td>
                        <td><small>${durationText}</small></td>
                        <td><small>${formatDate(alert.timestamp)}</small></td>
                    </tr>
                `;
            }).join('');
        }

        // Poblar filtro de sensores si está vacío
        const sensorFilter = document.getElementById('alertSensorFilter');
        if (sensorFilter.options.length === 1 && allSensors.length > 0) {
            sensorFilter.innerHTML = '<option value="">Todos los sensores</option>' +
                allSensors.map(s => `<option value="${s.sensor_id}">${s.sensor_id} - ${s.location.zone_name}</option>`).join('');
        }

    } catch (error) {
        console.error('Error loading alerts:', error);
        document.getElementById('alertsTableBody').innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-danger">
                    <i class="fas fa-exclamation-circle"></i> Error al cargar alertas: ${error.message}
                </td>
            </tr>
        `;
    }
}

// Event listener para cargar alertas cuando se selecciona la pestaña
document.getElementById('alerts-tab').addEventListener('click', function() {
    loadAlertsData();
});

// Event listener para cargar auditoría cuando se selecciona la pestaña
document.getElementById('audit-tab').addEventListener('click', function() {
    loadAuditData();
});

// Cargar datos al inicio (incluye alertas)
loadAllData();
loadAlertsData();

// Auto-refresh de alertas cada 30 segundos
setInterval(function() {
    loadAlertsData();
}, 30000);

// Auto-refresh completo del dashboard cada 60 segundos
setInterval(function() {
    loadAllData();
}, 60000);

// ========================================
// FUNCIONES DE VERIFICACIÓN MERKLE PROOF
// ========================================

// Función helper para verificar por ID desde botón de tabla
function verifyReadingById(readingId) {
    document.getElementById('readingIdInput').value = readingId;
    verifyReading();
    // Scroll suave a la sección de verificación
    document.getElementById('merkleProofResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Función principal de verificación con Merkle Proof
async function verifyReading() {
    const readingId = document.getElementById('readingIdInput').value;
    const resultDiv = document.getElementById('merkleProofResult');

    if (!readingId) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Por favor ingresa un ID de lectura válido</div>';
        return;
    }

    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Verificando lectura con Merkle Proof...</div>';

    try {
        const response = await fetch('/api/rollup/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reading_id: parseInt(readingId) })
        });

        if (!response.ok) {
            throw new Error('Error en la verificación');
        }

        const data = await response.json();

        if (data.valid) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h5 class="alert-heading"><i class="fas fa-check-circle"></i> Lectura Verificada Correctamente</h5>
                    <p class="mb-3">
                        La lectura ID <strong>${data.reading_id}</strong> ha sido verificada criptográficamente
                        y está incluida en el rollup de forma íntegra.
                    </p>
                    <hr>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <strong>Merkle Root:</strong><br>
                            <code style="font-size: 0.85em; word-break: break-all;">${data.merkle_root}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>TX Hash Cardano:</strong><br>
                            <code style="font-size: 0.85em; word-break: break-all;">${data.tx_hash || 'N/A'}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>Leaf Hash:</strong><br>
                            <code style="font-size: 0.85em; word-break: break-all;">${data.leaf_hash}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>Pasos del Proof:</strong><br>
                            <span class="badge bg-success">${data.proof.length} pasos</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong><i class="fas fa-lock"></i> Merkle Proof (Camino de Verificación):</strong>
                        <div class="mt-2" style="max-height: 200px; overflow-y: auto;">
                            ${data.proof.map((step, index) => `
                                <div class="alert alert-light mb-1 py-2">
                                    <strong>Paso ${index + 1}:</strong>
                                    <code style="font-size: 0.8em;">${step[0].substring(0, 40)}...</code>
                                    <span class="badge bg-primary">${step[1]}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="alert alert-info mb-0">
                        <h6><i class="fas fa-info-circle"></i> ¿Qué significa esto?</h6>
                        <ul class="mb-0" style="font-size: 0.9em;">
                            <li>Esta lectura está incluida criptográficamente en el rollup</li>
                            <li>El Merkle Root está guardado en el blockchain de Cardano (inmutable)</li>
                            <li>Cualquier modificación de los datos sería detectada instantáneamente</li>
                            <li>Solo se necesitaron ${data.proof.length} hashes para verificar (vs descargar todas las lecturas)</li>
                        </ul>
                    </div>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h5 class="alert-heading"><i class="fas fa-times-circle"></i> Verificación Fallida</h5>
                    <p class="mb-0">${data.error || 'La lectura no pudo ser verificada'}</p>
                </div>
            `;
        }

    } catch (error) {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <h5 class="alert-heading"><i class="fas fa-exclamation-circle"></i> Error</h5>
                <p class="mb-0">${error.message}</p>
                <small class="text-muted">Asegúrate de que el ID de lectura sea válido y que esté incluido en un rollup.</small>
            </div>
        `;
    }
}

// ========================================
// FUNCIONES DE ALERTAS DE ERRORES DE ROLLUP
// ========================================

async function loadRollupErrors() {
    const errorsList = document.getElementById('rollupErrorsList');
    const totalErrorsEl = document.getElementById('totalErrors');
    const unresolvedErrorsEl = document.getElementById('unresolvedErrors');

    // Mostrar loading
    errorsList.innerHTML = '<div class="text-white text-center"><i class="fas fa-spinner fa-spin"></i> Cargando errores...</div>';

    try {
        const response = await fetch('/api/rollup/errors?limit=10');

        if (!response.ok) {
            throw new Error('Error al cargar errores');
        }

        const data = await response.json();

        // Actualizar contadores
        totalErrorsEl.textContent = data.total_errors;
        unresolvedErrorsEl.textContent = data.unresolved_errors;

        // Mostrar errores
        if (data.errors.length === 0) {
            errorsList.innerHTML = `
                <div class="alert alert-success mb-0" style="background: rgba(255,255,255,0.95);">
                    <i class="fas fa-check-circle"></i> No hay errores registrados
                </div>
            `;
        } else {
            errorsList.innerHTML = data.errors.map(error => {
                const errorDate = new Date(error.execution_date);
                const dateStr = errorDate.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const badgeClass = error.resolved ? 'bg-success' : 'bg-danger';
                const badgeText = error.resolved ? 'Resuelto' : 'Pendiente';

                const errorTypeIcon = {
                    'blockchain_error': 'fa-link',
                    'validation_error': 'fa-exclamation-circle',
                    'network_error': 'fa-wifi'
                }[error.error_type] || 'fa-exclamation-triangle';

                return `
                    <div class="alert alert-light mb-2" style="background: rgba(255,255,255,0.95);">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <i class="fas ${errorTypeIcon}"></i>
                                <strong>${error.sensor_id}</strong>
                                <span class="badge ${badgeClass} ms-2">${badgeText}</span>
                            </div>
                            <small class="text-muted">${dateStr}</small>
                        </div>
                        <div style="font-size: 0.9em;">
                            <strong>Error:</strong> ${error.error_message.substring(0, 100)}${error.error_message.length > 100 ? '...' : ''}
                        </div>
                        ${error.readings_count ? `
                            <div style="font-size: 0.85em;" class="mt-1">
                                <i class="fas fa-database"></i> ${error.readings_count} lecturas afectadas
                            </div>
                        ` : ''}
                        ${error.retry_count > 0 ? `
                            <div style="font-size: 0.85em;" class="mt-1">
                                <i class="fas fa-redo"></i> ${error.retry_count} reintentos
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

    } catch (error) {
        errorsList.innerHTML = `
            <div class="alert alert-danger mb-0" style="background: rgba(255,255,255,0.95);">
                <i class="fas fa-exclamation-circle"></i> Error al cargar: ${error.message}
            </div>
        `;
        totalErrorsEl.textContent = '-';
        unresolvedErrorsEl.textContent = '-';
    }
}

// Cargar errores al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    loadRollupErrors();
});
</script>
</body>
</html>
