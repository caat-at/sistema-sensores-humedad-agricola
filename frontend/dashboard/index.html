<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Sensores Agrícolas</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
.sensor-card:hover{transform:translateY(-2px);transition:0.3s;box-shadow:0 4px 12px rgba(0,0,0,0.15);}
.badge-custom{padding:0.5em 1em;}
.btn-verification{
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  color: white;
  font-weight: 600;
  padding: 8px 20px;
  border-radius: 6px;
  transition: all 0.3s;
}
.btn-verification:hover{
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  color: white;
}
</style>
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-dark bg-primary">
<div class="container-fluid">
<span class="navbar-brand"><i class="fas fa-tint"></i> Dashboard Sensores Agrícolas</span>
<div class="d-flex align-items-center gap-3">
<a href="/static/verificacion.html" class="btn btn-verification btn-sm">
<i class="fas fa-check-circle"></i> Verificación Blockchain
</a>
<span class="text-white"><i class="fas fa-link"></i> Cardano Preview</span>
</div>
</div>
</nav>

<!-- Container Principal -->
<div class="container-fluid mt-4">

<!-- Estadísticas -->
<div class="row mb-4">
<div class="col-md-3">
<div class="card sensor-card">
<div class="card-body text-center">
<i class="fas fa-microchip fa-2x text-primary mb-2"></i>
<h3 id="totalSensors">0</h3>
<p class="text-muted mb-0">Sensores Activos</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card sensor-card">
<div class="card-body text-center">
<i class="fas fa-chart-line fa-2x text-success mb-2"></i>
<h3 id="totalReadings">0</h3>
<p class="text-muted mb-0">Lecturas Totales</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card sensor-card">
<div class="card-body text-center">
<i class="fas fa-clock fa-2x text-info mb-2"></i>
<h3 id="lastUpdate">--:--</h3>
<p class="text-muted mb-0">Última Actualización</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card sensor-card">
<div class="card-body text-center">
<button class="btn btn-primary w-100" onclick="loadAllData()">
<i class="fas fa-sync-alt"></i> Actualizar
</button>
</div>
</div>
</div>
</div>

<!-- Alertas Activas -->
<div class="row mb-4" id="alertsPanel" style="display:none;">
<div class="col-12">
<div class="alert alert-warning mb-3" role="alert">
<div class="row align-items-center">
<div class="col-md-2 text-center">
<i class="fas fa-exclamation-triangle fa-3x"></i>
</div>
<div class="col-md-10">
<h5 class="alert-heading mb-2"><i class="fas fa-bell"></i> Alertas Activas</h5>
<div class="row">
<div class="col-md-3">
<strong id="alertCriticalCount">0</strong> Críticas
</div>
<div class="col-md-3">
<strong id="alertHighCount">0</strong> Altas
</div>
<div class="col-md-3">
<strong id="alertLowCount">0</strong> Bajas
</div>
<div class="col-md-3">
<strong id="alertTotalCount">0</strong> Total
</div>
</div>
<button class="btn btn-sm btn-warning mt-2" onclick="document.getElementById('alerts-tab').click()">
<i class="fas fa-eye"></i> Ver Alertas
</button>
</div>
</div>
</div>
</div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
<li class="nav-item">
<button class="nav-link active" id="sensors-tab" data-bs-toggle="tab" data-bs-target="#sensors" type="button">
<i class="fas fa-microchip"></i> Sensores
</button>
</li>
<li class="nav-item">
<button class="nav-link" id="readings-tab" data-bs-toggle="tab" data-bs-target="#readings" type="button">
<i class="fas fa-chart-bar"></i> Lecturas por Sensor
</button>
</li>
<li class="nav-item">
<button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button">
<i class="fas fa-plus-circle"></i> Registrar Sensor
</button>
</li>
<li class="nav-item">
<button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button">
<i class="fas fa-bell"></i> Alertas <span class="badge bg-danger" id="alertsBadge" style="display:none;">0</span>
</button>
</li>
<li class="nav-item">
<button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button">
<i class="fas fa-check-double"></i> Auditoría Blockchain
</button>
</li>
</ul>

<!-- Tab Content -->
<div class="tab-content">

<!-- TAB: Sensores -->
<div class="tab-pane fade show active" id="sensors">
<div class="card">
<div class="card-header bg-white">
<h5 class="mb-0"><i class="fas fa-list"></i> Información Detallada de Sensores</h5>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-hover" id="sensorsTable">
<thead class="table-light">
<tr>
<th>ID</th>
<th>Zona / Ubicación</th>
<th>Coordenadas</th>
<th>Umbrales (%)</th>
<th>Intervalo</th>
<th>Estado</th>
<th>Fecha Instalación</th>
<th>Owner</th>
</tr>
</thead>
<tbody id="sensorsTableBody">
<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- TAB: Lecturas por Sensor -->
<div class="tab-pane fade" id="readings">
<div class="card mb-3">
<div class="card-header bg-white">
<div class="row align-items-center">
<div class="col-md-6">
<h5 class="mb-0"><i class="fas fa-filter"></i> Filtrar Lecturas</h5>
</div>
<div class="col-md-6">
<select class="form-select" id="sensorFilter" onchange="loadReadingsBySensor()">
<option value="">Todos los sensores</option>
</select>
</div>
</div>
</div>
<div class="card-body">
<canvas id="readingsChart" height="80"></canvas>
</div>
</div>

<div class="card">
<div class="card-header bg-white">
<h5 class="mb-0"><i class="fas fa-table"></i> Historial de Lecturas</h5>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-sm table-striped">
<thead>
<tr>
<th>Sensor ID</th>
<th>Humedad (%)</th>
<th>Temperatura (°C)</th>
<th>Nivel de Alerta</th>
<th>Fecha/Hora</th>
<th>TX Hash</th>
</tr>
</thead>
<tbody id="readingsTableBody">
<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- TAB: Registrar Sensor -->
<div class="tab-pane fade" id="register">
<div class="card" style="max-width:800px;margin:0 auto;">
<div class="card-header bg-white">
<h5 class="mb-0"><i class="fas fa-plus-circle"></i> Registrar Nuevo Sensor en Blockchain</h5>
</div>
<div class="card-body">
<form id="registerForm" class="row g-3">
<div class="col-md-12">
<label class="form-label"><i class="fas fa-map-marker-alt"></i> Nombre de la Zona</label>
<input type="text" class="form-control" id="zone" placeholder="Ej: Campo Norte - Parcela A" required>
</div>
<div class="col-md-6">
<label class="form-label"><i class="fas fa-globe"></i> Latitud</label>
<input type="number" class="form-control" id="lat" step="0.000001" placeholder="-34.603722" required>
</div>
<div class="col-md-6">
<label class="form-label"><i class="fas fa-globe"></i> Longitud</label>
<input type="number" class="form-control" id="lon" step="0.000001" placeholder="-58.381592" required>
</div>
<div class="col-md-4">
<label class="form-label"><i class="fas fa-arrow-down"></i> Humedad Mínima (%)</label>
<input type="number" class="form-control" id="minH" min="0" max="100" placeholder="30" required>
</div>
<div class="col-md-4">
<label class="form-label"><i class="fas fa-arrow-up"></i> Humedad Máxima (%)</label>
<input type="number" class="form-control" id="maxH" min="0" max="100" placeholder="70" required>
</div>
<div class="col-md-4">
<label class="form-label"><i class="fas fa-clock"></i> Intervalo (min)</label>
<input type="number" class="form-control" id="interval" min="1" placeholder="60" required>
</div>
<div class="col-12">
<button type="submit" class="btn btn-success btn-lg w-100">
<i class="fas fa-save"></i> Registrar en Blockchain
</button>
</div>
</form>
<div id="result" class="mt-3"></div>
</div>
</div>
</div>

<!-- TAB: Auditoría Blockchain -->
<div class="tab-pane fade" id="audit">
<div class="row mb-3">
<div class="col-md-12">
<div class="card">
<div class="card-header bg-white d-flex justify-content-between align-items-center">
<h5 class="mb-0"><i class="fas fa-check-double"></i> Auditoría de Integridad: Blockchain vs PostgreSQL</h5>
<button class="btn btn-primary btn-sm" onclick="loadAuditData()">
<i class="fas fa-sync-alt"></i> Actualizar
</button>
</div>
<div class="card-body">
<!-- Resumen -->
<div class="row mb-4">
<div class="col-md-3">
<div class="card bg-light">
<div class="card-body text-center">
<h4 id="auditIntegrity">--</h4>
<p class="mb-0 text-muted">Integridad</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-light">
<div class="card-body text-center">
<h4 id="auditMatches">--</h4>
<p class="mb-0 text-muted">Coincidencias</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-light">
<div class="card-body text-center">
<h4 id="auditDifferent">--</h4>
<p class="mb-0 text-muted">Valores Diferentes</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-light">
<div class="card-body text-center">
<h4 id="auditOnlyBC">--</h4>
<p class="mb-0 text-muted">Solo en Blockchain</p>
</div>
</div>
</div>
</div>

<!-- Tabla de comparación -->
<div class="table-responsive">
<table class="table table-sm table-hover">
<thead class="table-light">
<tr>
<th>#</th>
<th>Sensor</th>
<th>Timestamp Blockchain</th>
<th>Blockchain</th>
<th>PostgreSQL</th>
<th>Estado</th>
<th>TX Hash</th>
</tr>
</thead>
<tbody id="auditTableBody">
<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando auditoría...</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- TAB: Alertas -->
<div class="tab-pane fade" id="alerts">
<div class="card">
<div class="card-header bg-white d-flex justify-content-between align-items-center">
<h5 class="mb-0"><i class="fas fa-bell"></i> Sistema de Alertas en Tiempo Real</h5>
<button class="btn btn-primary btn-sm" onclick="loadAlertsData()">
<i class="fas fa-sync-alt"></i> Actualizar
</button>
</div>
<div class="card-body">
<!-- Resumen de Alertas -->
<div class="row mb-4">
<div class="col-md-3">
<div class="card bg-danger text-white">
<div class="card-body text-center">
<h3 id="alertCritical">0</h3>
<p class="mb-0">Críticas</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-warning">
<div class="card-body text-center">
<h3 id="alertHigh">0</h3>
<p class="mb-0">Altas</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-info text-white">
<div class="card-body text-center">
<h3 id="alertLow">0</h3>
<p class="mb-0">Bajas</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-light">
<div class="card-body text-center">
<h3 id="alertTotal">0</h3>
<p class="mb-0">Total (24h)</p>
</div>
</div>
</div>
</div>

<!-- Filtros -->
<div class="row mb-3">
<div class="col-md-4">
<select class="form-select" id="alertLevelFilter" onchange="loadAlertsData()">
<option value="">Todos los niveles</option>
<option value="Critical">Críticas</option>
<option value="High">Altas</option>
<option value="Low">Bajas</option>
</select>
</div>
<div class="col-md-4">
<select class="form-select" id="alertSensorFilter" onchange="loadAlertsData()">
<option value="">Todos los sensores</option>
</select>
</div>
</div>

<!-- Tabla de Alertas Activas -->
<div class="table-responsive">
<table class="table table-hover">
<thead class="table-light">
<tr>
<th>Nivel</th>
<th>Sensor</th>
<th>Zona</th>
<th>Humedad</th>
<th>Temperatura</th>
<th>Rango</th>
<th>Mensaje</th>
<th>Duración</th>
<th>Timestamp</th>
</tr>
</thead>
<tbody id="alertsTableBody">
<tr><td colspan="9" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando alertas...</td></tr>
</tbody>
</table>
</div>
</div>
</div>
</div>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = 'http://localhost:8000/api';
let chart;
let allSensors = [];
let allReadings = [];

// Función para formatear fecha
function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleString('es-AR', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
    });
}

// Función para obtener color según alerta
function getAlertBadge(level) {
    const colors = {
        Normal: 'success',
        Low: 'warning',
        High: 'warning',
        Critical: 'danger'
    };
    return `<span class="badge bg-${colors[level] || 'secondary'}">${level}</span>`;
}

// Cargar sensores con información detallada
async function loadSensors() {
    try {
        allSensors = await fetch(API + '/sensors').then(r => r.json());
        document.getElementById('totalSensors').textContent = allSensors.length;

        // Poblar filtro de sensores
        const filter = document.getElementById('sensorFilter');
        filter.innerHTML = '<option value="">Todos los sensores</option>' +
            allSensors.map(s => `<option value="${s.sensor_id}">${s.sensor_id} - ${s.location.zone_name}</option>`).join('');

        // Tabla detallada
        const tbody = document.getElementById('sensorsTableBody');
        tbody.innerHTML = allSensors.map(s => `
            <tr>
                <td><strong>${s.sensor_id}</strong></td>
                <td>${s.location.zone_name}</td>
                <td><small>${s.location.latitude.toFixed(4)}, ${s.location.longitude.toFixed(4)}</small></td>
                <td><span class="badge bg-info">${s.min_humidity_threshold}% - ${s.max_humidity_threshold}%</span></td>
                <td>${s.reading_interval_minutes} min</td>
                <td><span class="badge bg-${s.status === 'Active' ? 'success' : 'secondary'}">${s.status}</span></td>
                <td><small>${formatDate(s.installed_date)}</small></td>
                <td><small class="text-muted">${s.owner.substring(0, 8)}...</small></td>
            </tr>
        `).join('');
    } catch(e) {
        console.error('Error cargando sensores:', e);
    }
}

// Cargar lecturas filtradas por sensor
async function loadReadingsBySensor() {
    const sensorId = document.getElementById('sensorFilter').value;
    const url = sensorId ? `${API}/readings?sensor_id=${sensorId}&limit=20` : `${API}/readings?limit=20`;

    try {
        allReadings = await fetch(url).then(r => r.json());
        document.getElementById('totalReadings').textContent = allReadings.length;

        // Tabla de lecturas
        const tbody = document.getElementById('readingsTableBody');
        tbody.innerHTML = allReadings.map(r => `
            <tr>
                <td><strong>${r.sensor_id}</strong></td>
                <td><span class="badge badge-custom bg-primary">${r.humidity_percentage}%</span></td>
                <td>${r.temperature_celsius}°C</td>
                <td>${getAlertBadge(r.alert_level)}</td>
                <td><small>${formatDate(r.timestamp)}</small></td>
                <td>${r.tx_hash === 'PENDIENTE' ? '<span class="badge bg-warning">PENDIENTE</span>' : r.tx_hash && r.tx_hash.startsWith('simulated_tx_') ? `<span class="badge bg-secondary" title="${r.tx_hash}">SIMULADO</span>` : r.tx_hash ? `<a href="https://preview.cardanoscan.io/transaction/${r.tx_hash}" target="_blank" rel="noopener noreferrer" style="font-family:monospace;font-size:0.85em;" title="${r.tx_hash}">${r.tx_hash.substring(0, 8)}...${r.tx_hash.substring(r.tx_hash.length - 8)}</a>` : '<span style="color:#999;">-</span>'}</td>
            </tr>
        `).join('');

        // Gráfica
        updateChart();
    } catch(e) {
        console.error('Error cargando lecturas:', e);
    }
}

// Actualizar gráfica
function updateChart() {
    if (chart) chart.destroy();

    const ctx = document.getElementById('readingsChart');
    const labels = allReadings.map(r => `${r.sensor_id}\n${formatDate(r.timestamp).split(' ')[1]}`);

    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.reverse(),
            datasets: [{
                label: 'Humedad (%)',
                data: allReadings.map(r => r.humidity_percentage).reverse(),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4
            }, {
                label: 'Temperatura (°C)',
                data: allReadings.map(r => r.temperature_celsius).reverse(),
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true },
                title: { display: true, text: 'Historial de Lecturas' }
            }
        }
    });
}

// Cargar todos los datos
async function loadAllData() {
    await loadSensors();
    await loadReadingsBySensor();
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('es-AR');
}

// Formulario de registro
document.getElementById('registerForm').onsubmit = async (e) => {
    e.preventDefault();
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Enviando transacción a blockchain...</div>';

    try {
        const data = {
            location: {
                zone_name: zone.value,
                latitude: parseFloat(lat.value),
                longitude: parseFloat(lon.value)
            },
            min_humidity_threshold: parseInt(minH.value),
            max_humidity_threshold: parseInt(maxH.value),
            reading_interval_minutes: parseInt(interval.value)
        };

        const res = await fetch(API + '/sensors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const json = await res.json();

        if (res.ok) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle"></i> ${json.message}</h6>
                    <p class="mb-2">TxHash: <code>${json.tx_hash}</code></p>
                    <a href="${json.explorer_url}" target="_blank" class="btn btn-sm btn-primary">
                        <i class="fas fa-external-link-alt"></i> Ver en Cardano Explorer
                    </a>
                </div>
            `;
            e.target.reset();
            setTimeout(loadAllData, 3000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${json.detail || 'Error al registrar'}</div>`;
        }
    } catch(error) {
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Error: ${error.message}</div>`;
    }
};

// Cargar auditoría blockchain vs PostgreSQL
async function loadAuditData() {
    try {
        const response = await fetch(`${API}/audit/compare?limit=20`);
        const data = await response.json();

        if (!data.success) {
            console.error('Error en auditoría:', data);
            return;
        }

        // Actualizar tarjetas de resumen
        document.getElementById('auditIntegrity').textContent = data.resumen.integridad_porcentaje + '%';
        document.getElementById('auditMatches').textContent = data.resumen.matches;
        document.getElementById('auditDifferent').textContent = data.resumen.diferentes;
        document.getElementById('auditOnlyBC').textContent = data.resumen.solo_blockchain;

        // Poblar tabla de comparación
        const tbody = document.getElementById('auditTableBody');
        tbody.innerHTML = data.comparaciones.map((comp, idx) => {
            const bcData = `H:${comp.blockchain.humidity}% T:${comp.blockchain.temperature}°C`;
            const sqlData = comp.postgresql
                ? `H:${comp.postgresql.humidity}% T:${comp.postgresql.temperature}°C`
                : '<span style="color:#999;">[NO ENCONTRADO]</span>';

            // Badge de estado
            let statusBadge;
            if (comp.match_status === 'match') {
                statusBadge = '<span class="badge bg-success"><i class="fas fa-check"></i> MATCH</span>';
            } else if (comp.match_status === 'different_values') {
                statusBadge = '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle"></i> DIFERENTES</span>';
            } else {
                statusBadge = '<span class="badge bg-secondary"><i class="fas fa-times"></i> SOLO BC</span>';
            }

            // Link de TX Hash
            const txHashLink = comp.tx_hash
                ? `<a href="https://preview.cardanoscan.io/transaction/${comp.tx_hash}" target="_blank" rel="noopener noreferrer" style="font-family:monospace;font-size:0.85em;" title="${comp.tx_hash}">${comp.tx_hash.substring(0, 8)}...${comp.tx_hash.substring(comp.tx_hash.length - 8)}</a>`
                : '<span style="color:#999;">-</span>';

            // Formato de timestamp
            const timestampBC = formatDate(comp.timestamp_bc);

            return `
                <tr>
                    <td>${idx + 1}</td>
                    <td><strong>${comp.sensor_id}</strong></td>
                    <td><small>${timestampBC}</small></td>
                    <td><span class="badge badge-custom bg-info">${bcData}</span></td>
                    <td><span class="badge badge-custom bg-${comp.postgresql ? 'info' : 'secondary'}">${sqlData}</span></td>
                    <td>${statusBadge}</td>
                    <td>${txHashLink}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading audit data:', error);
        document.getElementById('auditTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger">
                    <i class="fas fa-exclamation-circle"></i> Error al cargar datos de auditoría: ${error.message}
                </td>
            </tr>
        `;
    }
}

// Cargar alertas activas
async function loadAlertsData() {
    try {
        // Obtener filtros
        const level = document.getElementById('alertLevelFilter')?.value || '';
        const sensorId = document.getElementById('alertSensorFilter')?.value || '';

        // Construir URL con filtros
        let url = `${API}/alerts/active`;
        const params = new URLSearchParams();
        if (level) params.append('level', level);
        if (sensorId) params.append('sensor_id', sensorId);
        if (params.toString()) url += '?' + params.toString();

        const response = await fetch(url);
        const alerts = await response.json();

        // Obtener resumen
        const summaryResponse = await fetch(`${API}/alerts/summary`);
        const summary = await summaryResponse.json();

        // Actualizar tarjetas de resumen
        document.getElementById('alertCritical').textContent = summary.critical_alerts || 0;
        document.getElementById('alertHigh').textContent = summary.high_alerts || 0;
        document.getElementById('alertLow').textContent = summary.low_alerts || 0;
        document.getElementById('alertTotal').textContent = summary.total_alerts || 0;

        // Actualizar panel superior de alertas
        const totalAlerts = summary.total_alerts || 0;
        if (totalAlerts > 0) {
            document.getElementById('alertsPanel').style.display = 'block';
            document.getElementById('alertCriticalCount').textContent = summary.critical_alerts || 0;
            document.getElementById('alertHighCount').textContent = summary.high_alerts || 0;
            document.getElementById('alertLowCount').textContent = summary.low_alerts || 0;
            document.getElementById('alertTotalCount').textContent = totalAlerts;

            // Actualizar badge en tab
            const badge = document.getElementById('alertsBadge');
            badge.textContent = totalAlerts;
            badge.style.display = 'inline';
        } else {
            document.getElementById('alertsPanel').style.display = 'none';
            document.getElementById('alertsBadge').style.display = 'none';
        }

        // Poblar tabla de alertas
        const tbody = document.getElementById('alertsTableBody');

        if (alerts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-success"><i class="fas fa-check-circle"></i> No hay alertas activas</td></tr>';
        } else {
            tbody.innerHTML = alerts.map(alert => {
                // Badge de nivel
                let levelBadge = '';
                if (alert.alert_level === 'Critical') {
                    levelBadge = '<span class="badge bg-danger"><i class="fas fa-exclamation-circle"></i> CRÍTICA</span>';
                } else if (alert.alert_level === 'High') {
                    levelBadge = '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle"></i> ALTA</span>';
                } else if (alert.alert_level === 'Low') {
                    levelBadge = '<span class="badge bg-info"><i class="fas fa-info-circle"></i> BAJA</span>';
                }

                // Formatear duración
                const duration = alert.duration_minutes;
                let durationText = '';
                if (duration < 60) {
                    durationText = `${duration} min`;
                } else if (duration < 1440) {
                    durationText = `${Math.floor(duration / 60)}h ${duration % 60}min`;
                } else {
                    durationText = `${Math.floor(duration / 1440)}d ${Math.floor((duration % 1440) / 60)}h`;
                }

                return `
                    <tr class="${alert.alert_level === 'Critical' ? 'table-danger' : ''}">
                        <td>${levelBadge}</td>
                        <td><strong>${alert.sensor_id}</strong></td>
                        <td>${alert.zone_name}</td>
                        <td><span class="badge badge-custom bg-primary">${alert.humidity_percentage}%</span></td>
                        <td>${alert.temperature_celsius}°C</td>
                        <td><small>${alert.threshold_min}% - ${alert.threshold_max}%</small></td>
                        <td><small>${alert.message}</small></td>
                        <td><small>${durationText}</small></td>
                        <td><small>${formatDate(alert.timestamp)}</small></td>
                    </tr>
                `;
            }).join('');
        }

        // Poblar filtro de sensores si está vacío
        const sensorFilter = document.getElementById('alertSensorFilter');
        if (sensorFilter.options.length === 1 && allSensors.length > 0) {
            sensorFilter.innerHTML = '<option value="">Todos los sensores</option>' +
                allSensors.map(s => `<option value="${s.sensor_id}">${s.sensor_id} - ${s.location.zone_name}</option>`).join('');
        }

    } catch (error) {
        console.error('Error loading alerts:', error);
        document.getElementById('alertsTableBody').innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-danger">
                    <i class="fas fa-exclamation-circle"></i> Error al cargar alertas: ${error.message}
                </td>
            </tr>
        `;
    }
}

// Event listener para cargar alertas cuando se selecciona la pestaña
document.getElementById('alerts-tab').addEventListener('click', function() {
    loadAlertsData();
});

// Event listener para cargar auditoría cuando se selecciona la pestaña
document.getElementById('audit-tab').addEventListener('click', function() {
    loadAuditData();
});

// Cargar datos al inicio (incluye alertas)
loadAllData();
loadAlertsData();

// Auto-refresh de alertas cada 30 segundos
setInterval(function() {
    loadAlertsData();
}, 30000);

// Auto-refresh completo del dashboard cada 60 segundos
setInterval(function() {
    loadAllData();
}, 60000);
</script>
</body>
</html>
